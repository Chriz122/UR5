import numpy as np
import cv2
from pathlib import Path
import glob

# 讀取相機座標與手臂座標
def read_coordinates(camera_file, robot_file):
    camera_coords = []
    robot_coords = []

    # 讀取相機座標
    with open(camera_file, "r") as cam_file:
        for line in cam_file:
            camera_coords.append([float(x) for x in line.strip().split()])

    # 讀取手臂座標
    with open(robot_file, "r") as rob_file:
        for line in rob_file:
            robot_coords.append([float(x) for x in line.strip().split()])

    return np.array(camera_coords), np.array(robot_coords)

# 計算轉移矩陣
def calculate_transformation_matrix(camera_coords, robot_coords):
    # 使用 OpenCV 的 estimateAffine3D 計算轉移矩陣
    retval, transformation_matrix, inliers = cv2.estimateAffine3D(camera_coords, robot_coords)
    if retval:
        return transformation_matrix
    else:
        raise ValueError("無法計算轉移矩陣，請檢查輸入座標是否正確對應")

# 提取棋盤格角點
def extract_chessboard_corners(image_folder, pattern_size):
    camera_coords = []
    
    # 獲取所有圖片檔案
    image_files = glob.glob(f"{image_folder}/*.png")
    
    for image_file in image_files:
        image = cv2.imread(image_file)
        gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)

        # 找到棋盤格角點
        ret, corners = cv2.findChessboardCorners(gray, pattern_size, None)
        if ret:
            # 儲存角點座標
            camera_coords.append(corners.reshape(-1, 3))
        else:
            print(f"未能在圖片 {image_file} 中找到棋盤格角點")

    return np.array(camera_coords)

# 儲存轉移矩陣到 .txt 檔案
def save_transformation_matrix(transformation_matrix, output_file):
    with open(output_file, "w") as f:
        for row in transformation_matrix:
            f.write(" ".join(map(str, row)) + "\n")
    print(f"轉移矩陣已儲存至 {output_file}")

# 主程式
if __name__ == "__main__":
    temp = 1  # 第幾組資料
    chessboard_pattern = (7, 7)  # 棋盤格內角點數量 (列, 行)

    image_folder = Path(f"data/images/A{temp}.png")  # 棋盤格圖片資料夾

    # 提取棋盤格角點
    camera_coords = extract_chessboard_corners(image_folder, chessboard_pattern)

    # 確保手臂座標檔案存在
    robot_file = Path(f"data/txts/D{temp}.txt")
    if not robot_file.exists():
        raise FileNotFoundError("請確保手臂座標檔案存在於 data/txts 資料夾中")

    # 讀取手臂座標
    _, robot_coords = read_coordinates(None, robot_file)

    # 確保相機座標與手臂座標數量一致
    if len(camera_coords) != len(robot_coords):
        raise ValueError("相機座標與手臂座標數量不一致，請檢查資料")

    # 計算轉移矩陣
    try:
        transformation_matrix = calculate_transformation_matrix(camera_coords, robot_coords)
        print("轉移矩陣:")
        print(transformation_matrix)
    except ValueError as e:
        print(e)

    # 儲存轉移矩陣到 .txt 檔案
    output_file = Path("data/txts/transformation_matrix.txt")
    save_transformation_matrix(transformation_matrix, output_file)